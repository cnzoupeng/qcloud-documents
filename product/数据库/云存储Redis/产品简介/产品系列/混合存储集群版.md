Redis混合存储集群版源自腾讯集团内部广泛使用的KV存储数据库Tendis，Tendis是腾讯集团自研兼容Redis协议的Rocksdb存储引擎，拥有高性能、高压缩比、高稳定性的特性，以及在腾讯集团内部多年丰富的运营经验。混合存储版由Redis和Tendis两大组件构成，适合在KV存储场景中使用，在存储场景中平衡了性能和成本之间难题，在冷数据占比较大的场景中可以帮助业务降低多达85%的运营成本。混合存储版本完全兼容Redis 4.0集群版的版本命令，使用内存版本的业务无需担心迁移到混合存储版本的兼容性问题。混合存储版的全部数据都将存储到磁盘，全量Key和热Key的Value会存储于内存，系统架构图如下所示：

![](http://file.tapd.oa.com//tfl/captures/2020-03/tapd_10104911_base64_1583822755_78.png)

### 产品特点
- **数据降冷**
  混合存储版将全部数据存储在磁盘，仅将最近有访问过的热数据存储在内存中，这样将大大降低业务存储成本，同时又能享受到Redis协议的便利。在游戏场景中近期没有登陆的用户数据将自动从内存驱逐出去，仅当用户登陆后数据才会重新缓存到内存。在内容分发场景中，发布时间越久的文章越不容易被访问，将文章内存存储到混合存储版本中，存储引擎将自动按照热度缓存数据，保障热门内容即时响应，同理在社交、电商、出行等场景中都会出现非结构化的数据随着时间的推移由热变冷的场景，使用Redis混合存储版本将自动缓存热数据，在性能和成本之间做到平衡。在冷数据占比较大的场景中，混合存储版本将帮助业务降低多达85%的使用成本。

- **提升研发效率**

  在传统的Redis缓存 + 磁盘数据库存储的架构中，业务需要在逻辑层处理数据的降冷和预热，还要面临缓存击穿的安全风险，使用Redis混合存储产品后，原有的缓存+存储两层架构将被数据库整合，业务开发人员将不再需要处理冷热交换逻辑，大大提升开发效率。

- **数据压缩**

  混合存储版本使用RocksDB引擎将数据存储在磁盘，默认启用数据压缩，通常可以提供约3倍的压缩效果，将大大降低业务的存储成本。
- **时间点回档**

  混合存储支持全量备份和增量备份，完成的增量日志将支持我们提供按时间点回档的功能，相对于Redis仅支持全量回档的功能，混合存储版本在回档能力上又显著的提升。

### 推荐使用场景
- 存储场景

  将Redis作为主要存储引擎，而不是将Redis作为缓存的数据加速访问的场景。
- 时延不敏感

  由于冷数据需要从磁盘读取，因此对冷数据的访问时延将明显提升，Redis内存版本的访问时延可以控制在1ms以内，但是混合存储版本的对冷数据的访问时延可能高达数十毫秒甚至上百毫秒。
- 数据冷热分布明显

  混合存储非常适合数据随着时间的推移由热变冷的场景，热数据密集访问并且要求较好响应时延，冷数据通过预热之后可以达到较好响应时延。

### 不建议使用场景
- 缓存场景
    - 性能不满足：缓存场景对性要求高，混合存储版本在冷数据性能上明显低于内存版本，具体性能请参考性能指标文档。
    - 成本可能提升：混合存储版本增加了磁盘存储空间和磁盘存储计算节点，在缓存场景中内存的容量接近磁盘容量，因此业务成本不但没有降低反而会提升。
- 时延敏感场景
    - 由于冷数据需要从磁盘读取，因此对冷数据的访问时延将明显提升，Redis内存版本的访问时延可以控制在1ms以内，但是混合存储版本的对冷数据的访问时延可能高达数十毫秒甚至上百毫秒。因此混合存储版本不适合时延敏感对场景。

### 产品规格
| 分片数量|总缓存容量(GB)| 总磁盘容量范围（GB）|最大写入性能（OPS）|
| :-----| :-----| ----: | ----: | ----: | 
| 3 | 18 | 150-180|45,000|
| 4 | 32 | 200-320|60,000|
| 4 | 64 | 200-640|60,000|
| 4 | 128 | 400-1280|60,000|
| 4 | 256 | 400-2560|60,000|
| 8 | 128 | 400-1280|120,000|
| 8 | 256 | 800-2560|120,000|
| 8 | 512 | 800-5120|120,000|
| 16 | 256 | 800-2560|240,000|
| 16 | 512 | 1600-5120|240,000|
| 16 | 1024 | 1600-10240|240,000|
| 32 | 512 | 1600-5120|480,000|
| 32 | 1024 | 3200-10240|480,000|
| 32 | 2048 | 3200-20480|480,000|

备注：
- 磁盘最小容量必须大余内存容量，否则可能存在数据无法写入的情况；
- 磁盘配置过小，可能存在内存无法存储足够的Key（所有的Key都会缓存到内存，淘汰的只是Value），请评估好磁盘空间；
- 最大写入性能是在Set命令128字节value的情况下的测试结果，测试命令如下：

    ```
    redis-benchmark -h 10.0.0.5 -p 6379 -c 100 -n 60000000 -r 1000000000 -d 128 -t set -a passwd
    ```

### 数据降冷说明
- maxmemory-policy参数配置说明
    
    混合存储版本maxmemory-policy 策略仅支持allkeyslru和allkeyslfu，当到达最大内存时候仅驱逐满足lru或者lfu条件的Value，不驱逐Key，相对于内存版本的Redis会同时驱逐key和value。
- Expire 语义说明

    对于设置了Expire Time的key，混合存储版将保持原有的语义，将到期的Key和Value从内存和磁盘中删除。EXPIRE、EXPIREAT、PEXPIRE、PEXPIREAT命令对key进行设置对过期时间也是相同原理，到期后key和Value都会删除。 

- 大Key驱逐说明

    为了保障读性能，混合存储当前版本对于超过8MB或者filed超过1000个的复杂结构Value（非string），将不从内存中驱逐，因此如果存在大Hash等复杂数据结构情况下，降冷大效果不明显，后续我们将持续优化。


### 命令兼容性
Redis混合存储版本完全兼容Redis 4.0集群版的命令，详情请参考命令兼容性文档，但是在以下情况请谨慎使用：
    
- 使用lua场景中，lua脚本需要访问的所有key都必须显示的放置到参数列表，否则遇到没有显示指定Key的Value在被内存驱逐后，服务将返回错误；

    ```
    EVALSHA sha1 numkeys key [key ...] arg [arg ...]
    EVAL script numkeys key [key ...] arg [arg ...]
    ```
- List命令族中的 **linsert、lrem** 命令不建议使用，这两个命令会在磁盘中遍历list节点，性能较差，list节点数较大时，命令会执行超时。

